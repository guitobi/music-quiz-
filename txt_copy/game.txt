const socket = io(); 

let currentRoom = null;
let currentUserNickname = null;
let isHost = false;

socket.emit('hello', 'Hello from client');
socket.on('response', data => console.log(data));

const messageSendBtnEl = document.querySelector('.btn');
const inputEl = document.querySelector('#messageInput');
const chatDivEl = document.querySelector('.messageContainer');
const createRoomBtn = document.querySelector('.createRoom');
const joinRoomBtn = document.querySelector('.joinRoom');
const startGameBtn = document.querySelector('.startGame');
const nameInputEl = document.querySelector('.nameInput');
const errorDiv = document.querySelector('.error-div');
const roomInfo = document.querySelector('.roomInfo');
const playersListDiv = document.getElementById('playerList');
const roomCodeInput = document.querySelector('.roomCode');
const volumeSlider = document.getElementById('volumeSlider');

// селектори щоб забрати їх з екрану при приєднанні до кімнати
const forms = document.querySelector('.form-group');
const lobbySection = document.querySelectorAll('.lobby-section');
const initialForms = document.getElementById('initial-forms');
const activeLobbyContent = document.getElementById('active-lobby-content');
const body = document.querySelector('body');

socket.on('message', ({userNickname, text}) => {
    const chatMessages = document.getElementById('chat-messages');
    const messageElement = document.createElement('p');
    messageElement.innerHTML = `<strong>${userNickname}:</strong> ${text}`;
    chatMessages.appendChild(messageElement);
    chatMessages.scrollTop = chatMessages.scrollHeight;
});

socket.on('room-joined', ({userNickname, roomCode, Host}) => {
    initialForms.hidden = true;
    activeLobbyContent.hidden = false;
    body.classList.add('active-lobby');
    isHost = Host;
    if (isHost) {
        document.getElementById('host-controls').hidden = false;
    } else {
        document.getElementById('host-controls').hidden = true;
    }
    currentRoom = roomCode;
    roomInfo.textContent = `${userNickname.trim()} приєднався до: ${roomCode}`;
    currentUserNickname = userNickname;
    nameInputEl.value = '';
    roomCodeInput.value = '';
    updatePlayersList();
});

socket.on('players-update', players => {
    playersListDiv.innerText = players.map(p => `${p.name}`).join('\n');
});

socket.on('game-started', ({ roomCode }) => {
    window.location.href = `game.html?roomCode=${roomCode}&nickname=${currentUserNickname}`;
});

socket.on('error-nickname-taken', () => {
    errorDiv.textContent = `This nickname is alredy taken.(єбать ти лох, точно шось з хохлами хотів, та?)`;
});

socket.on('error-game-in-progress', () => {
    errorDiv.textContent = `Game is already in progress`;
});

socket.on('players-update', (players) => {
    const playerListItems = document.querySelector('.player-list-items');
    playerListItems.innerHTML = '';
    
    players.forEach((player, index) => {
        const playerElement = document.createElement('div');
        playerElement.className = 'player-item';
        playerElement.innerHTML = `
            <span class="name">${player.name}</span>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span class="score">${player.score || 0}</span>
                ${index === 0 ? '<span class="host-badge">HOST</span>' : ''}
            </div>
        `;
        playerListItems.appendChild(playerElement);
    });
});

socket.on('playlist-preview', ({ tracks, playlistName }) => {
    const previewContainer = document.getElementById('playlistTracksPreview');
    previewContainer.innerHTML = `<h4>${playlistName}</h4>`;
    
    tracks.forEach(track => {
        const trackElement = document.createElement('div');
        trackElement.className = 'playlist-track';
        trackElement.innerHTML = `<strong>${track.name}</strong> - ${track.artist}`;
        previewContainer.appendChild(trackElement);
    });
});

socket.on('volume-updated', ({ volume, playerId }) => {
    const volumeSlider = document.getElementById('volumeSlider');
    if (socket.id !== playerId) {
        volumeSlider.value = volume;
    }
});

socket.on('playlist-updated', ({ playlistId, playlistName, hostId }) => {
    document.getElementById('currentPlaylistName').textContent = playlistName;
    if (socket.id !== hostId) {
        document.getElementById('playlistIdInput').value = playlistId;
    }
});

const updatePlayersList = () => {
    const playerListItems = document.querySelector('.player-list-items');
    playerListItems.innerHTML = '';
    if (!currentRoom || !rooms[currentRoom]) return;
    const players = rooms[currentRoom].players;
    Object.entries(players).forEach(([socketId, player]) => {
        const playerElement = document.createElement('div');
        playerElement.className = 'player-item';
        playerElement.innerHTML = `
            <span class="name">${player.name}</span>
            <span class="score">${player.score || 0}</span>
        `;
        playerListItems.appendChild(playerElement);
    });
};

const createRoom = async () => {
    // isHost = true;
    // startGameBtn.hidden = true;
    errorDiv.innerHTML =  '';
    const userNickname = nameInputEl.value.trim();
    if(userNickname === '') {
        const errorP = document.createElement('p');
        errorP.textContent = 'Enter a valid nickname';
        errorDiv.appendChild(errorP);
        return;
    } else {
        try {
            currentUserNickname = userNickname;
            const res = await fetch('/api/rooms', {
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                playerName: currentUserNickname
            })
            });
            const data = await res.json();
            const roomCodeParsed = data.roomCode;
            socket.emit('join-room', {userNickname, roomCode: roomCodeParsed});
            // startGameBtn.removeAttribute('hidden');
        } catch (err) {
            console.error(err);
        }
    };
};

const joinRoom = async () => {
    console.log(`Checking Nickname: "${nameInputEl.value}", Room Code: "${roomCodeInput.value}"`);
    errorDiv.innerHTML =  '';
    const userNickname = nameInputEl.value.trim();
    const roomCode = roomCodeInput.value.trim();
    if(userNickname === '' || roomCode === '') {
        const errorP = document.createElement('p');
        errorP.textContent = 'Enter a valid nickname or room code!';
        errorDiv.appendChild(errorP);
        return;
    } else {
        try {
        const res = await fetch(`/api/rooms/${roomCode}`);
        if (!res.ok) {
            errorDiv.textContent = `ЖОПА з вашим json`
            return;
        };
        const data = await res.json();
        if (!data.exists) {
            errorDiv.textContent = 'ЖОПЖОПА з вашим json ( ігор )';
            return;
        };
        socket.emit('join-room', {userNickname, roomCode});
        currentRoom = roomCode;
        currentUserNickname = userNickname;
        roomCodeInput.value = '';
        nameInputEl.value = '';
        } catch (err) {
        console.error(err);
        }
    } 
};

const startGame = () => {
    socket.emit('start-game', {roomCode: currentRoom});
};

messageSendBtnEl.addEventListener('click', () => {
        if (!currentRoom) {
        alert('У тебе немає друзів');
        return;
    }
    
    socket.emit('message', {
        userNickname: currentUserNickname,
        roomCode: currentRoom,
        text: inputEl.value
    });
    inputEl.value = '';
});

createRoomBtn.addEventListener('click', createRoom);
joinRoomBtn.addEventListener('click', joinRoom);
startGameBtn.addEventListener('click', startGame);

volumeSlider.addEventListener('input', () => {
    socket.emit('volume-change', {
        roomCode: currentRoom,
        volume: volumeSlider.value
    });
});

messageSendBtnEl.addEventListener('click', () => {
    if (!currentRoom || !currentUserNickname) {
        alert('Please join a room first');
        return;
    }
    const message = inputEl.value.trim();
    if (message === '') return;
    socket.emit('message', {
        userNickname: currentUserNickname,
        roomCode: currentRoom,
        text: message
    });
    inputEl.value = '';
});

inputEl.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        messageSendBtnEl.click();
    }
});

document.querySelectorAll('.preset-buttons button').forEach(button => {
    button.addEventListener('click', () => {
        const playlistId = button.getAttribute('data-id');
        const playlistName = button.getAttribute('data-name');
        document.getElementById('playlistIdInput').value = playlistId;
        document.getElementById('currentPlaylistName').textContent = playlistName;
        if (isHost) {
            socket.emit('change-playlist', {
                roomCode: currentRoom,
                playlistId: playlistId,
                playlistName: playlistName
            });
        }
    });
});

document.getElementById('applyPlaylistBtn').addEventListener('click', () => {
    const playlistId = document.getElementById('playlistIdInput').value.trim();
    if (playlistId && isHost) {
        // Тут можна додати логіку для отримання назви плейлиста або використати заглушку
        const playlistName = playlistId.substring(0, 10) + '...';
        document.getElementById('currentPlaylistName').textContent = playlistName;
        
        socket.emit('change-playlist', {
            roomCode: currentRoom,
            playlistId: playlistId,
            playlistName: playlistName
        });
    }
});